workflow:
  rules:  # Do not create pipelines for tag updates
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

include: ".pipeline-common.yml"

stages:
  - child-pipelines
  - scheduled

aea:
  stage: child-pipelines
  trigger:
    include:
      - local: .pipeline-aea.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    PARENT_CI_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE

hpc:
  stage: child-pipelines
  trigger:
    include:
      - local: .pipeline-hpc.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    PARENT_CI_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE

win:
  stage: child-pipelines
  trigger:
    include:
      - local: .pipeline-win.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

mac:
  stage: child-pipelines
  trigger:
    include:
      - local: .pipeline-mac.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

deploy:
  stage: child-pipelines
  trigger:
    include:
      - local: .pipeline-deploy.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"

conda-build-matrix:
  extends:
    - .linux_before_script
  timeout: 4h
  stage: scheduled
  variables:
    GIT_STRATEGY: clone
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    # Override default permissions. Set group to rx with no write permissions.
    - umask 0022
    - mkdir ${conda_artifacts_directory}
    - pytest recipe-matrix/matrix.py -v --no-showlocals --tb=short
    - conda build purge --croot ${croot}/recipe-matrix
  tags:
    - shell-aea
