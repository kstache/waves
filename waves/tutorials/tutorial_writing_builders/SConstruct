#! /usr/bin/env python
import os
import pathlib

import waves


# Write an example custom builder using the WAVES builder factory template
def solver_builder_factory(
    environment: str = "",
    action_prefix: str = "cd ${TARGET.dir.abspath} &&",
    program: str = "solver",
    program_required: str = "",
    program_options: str = "",
    subcommand: str = "implicit",
    subcommand_required: str = "--input-file ${SOURCES[0].abspath} --output-file=${TARGETS[0].abspath}",
    subcommand_options: str = "",
    action_suffix: str = "> ${TARGETS[-1].abspath} 2>&1",
    emitter=waves.scons_extensions.first_target_emitter,
    **kwargs
) -> Builder:
    """
    This builder factory extends :meth:`waves.scons_extensions.first_target_builder_factory`. This builder factory uses
    the :meth:`waves.scons_extensions.first_target_emitter`. At least one task target must be specified in the task
    definition and the last target will always be the expected STDOUT and STDERR redirection output file,
    ``TARGETS[-1]`` ending in ``*.stdout``.

    .. warning::

       Users overriding the ``emitter`` keyword argument are responsible for providing an emitter with equivalent STDOUT
       file handling behavior as :meth:`waves.scons_extensions.first_target_emitter` or updating the ``action_suffix``
       option to match their emitter's behavior.

    With the default options this builder requires the following sources file provided in the order:

    1. solver program's routine subcommand input file: ``*.yaml``

    .. code-block::
       :caption: action string construction

       ${environment} ${action_prefix} ${program} ${program_required} ${program_options} ${subcommand} ${subcommand_required} ${subcommand_options} ${action_suffix}

    .. code-block::
       :caption: action string default expansion

       ${environment} cd ${TARGET.dir.abspath} && solver ${program_required} ${program_optional} implicit --input-file ${SOURCE.abspath} --output-file ${TARGETS[0].abspath} ${subcommand_options} > ${TARGETS[-1].abspath} 2>&1

    .. code-block::
       :caption: SConstruct

       import waves
       env = Environment()
       env.AddMethod(waves.scons_extensions.add_program, "AddProgram")
       env["solver"] = env.AddProgram(["solver"])
       env.Append(BUILDERS={"Solver": solver_explicit_builder_factory()})
       env.Solver(
           target=["target.out"],
           source=["source.yaml"],
       )

    The builder returned by this factory accepts all SCons Builder arguments. The arguments of this function are also
    available as keyword arguments of the builder. When provided during task definition, the task keyword arguments
    override the builder keyword arguments.

    :param environment: This variable is intended primarily for use with builders and tasks that can not execute from an
        SCons construction environment. For instance, when tasks execute on a remote server with SSH wrapped actions
        using :meth:`waves.scons_extensions.ssh_builder_actions` and therefore must initialize the remote environment as
        part of the builder action.
    :param action_prefix: This variable is intended to perform directory change operations prior to program execution
    :param program: The solver program absolute or relative path
    :param program_required: Space delimited string of required solver program options and arguments that are crucial to
        builder behavior and should not be modified except by advanced users
    :param program_options: Space delimited string of optional solver program options and arguments that can be freely
        modified by the user
    :param subcommand: The solver program's routine subcommand absolute or relative path
    :param subcommand_required: Space delimited string of required solver program's routine subcommand options and
        arguments that are crucial to builder behavior and should not be modified except by advanced users.
    :param subcommand_options: Space delimited string of optional solver program's routine subcommand options and
        arguments that can be freely modified by the user
    :param action_suffix: This variable is intended to perform program STDOUT and STDERR redirection operations.
    :param emitter: An SCons emitter function. This is not a keyword argument in the action string.
    :param kwargs: Any additional keyword arguments are passed directly to the SCons builder object.

    :return: Solver journal builder
    """  # noqa: E501
    builder = waves.scons_extensions.first_target_builder_factory(
        environment=environment,
        action_prefix=action_prefix,
        program=program,
        program_required=program_required,
        program_options=program_options,
        subcommand=subcommand,
        subcommand_required=subcommand_required,
        subcommand_options=subcommand_options,
        action_suffix=action_suffix,
        emitter=emitter,
        **kwargs
    )
    return builder


AddOption(
    "--build-dir",
    dest="variant_dir_base",
    default="build",
    nargs=1,
    type="string",
    action="store",
    metavar="DIR",
    help="SCons build (variant) root directory. Relative or absolute path. (default: '%default')"
)
AddOption(
    "--solve-cpus",
    dest="solve_cpus",
    default=1,
    nargs=1,
    type="int",
    action="store",
    metavar="N",
    help="Run the solver task using N CPUs. (default: '%default')"
)

env = Environment(
    ENV=os.environ.copy(),
    variant_dir_base=GetOption("variant_dir_base"),
    solve_cpus=GetOption("solve_cpus"),
)
env.AddMethod(waves.scons_extensions.project_help_message, "ProjectHelp")
env.AddMethod(waves.scons_extensions.add_program, "AddProgram")

# Conditionally print failed task *.stdout files
waves.scons_extensions.print_build_failures()

# Empty defaults list to avoid building all simulation targets by default
env.Default()

# Add project builders and scanners
solver_executable = pathlib.Path("solver").resolve()
env["solver"] = env.AddProgram([solver_executable])
env.Append(BUILDERS={
    "Solver": solver_builder_factory(subcommand_options="$(--solve-cpus=${solve_cpus}$)")
})

# Build path object for extension and re-use
variant_dir_base = pathlib.Path(env["variant_dir_base"])

# Add simulation targets
workflow_configurations = [
    "implicit_workflow"
]
for workflow in workflow_configurations:
    build_dir = variant_dir_base / workflow
    SConscript(workflow, variant_dir=build_dir, exports="env", duplicate=False)

# Print project local help
env.ProjectHelp()
