#! /usr/bin/env python

import pathlib

# Inherit the parent construction environment
Import(['env', 'project_substitution_dictionary'])

# Perform variable substitution on Sphinx configuration file
env.Substfile(
    "conf.py.in",
    SUBST_DICT=project_substitution_dictionary)

# Write shell script help messages to documentation build files
abaqus_wrapper_node = env.Command(
    target='abaqus_wrapper_message.txt',
    source=env['abaqus_wrapper'],
    action='${SOURCE.abspath} > ${TARGET.abspath}')

# Copy targets to the build/docs directory
project_dir = project_substitution_dictionary['@project_dir@']
eabm_dir = project_substitution_dictionary['@eabm_dir@']
tutorial_01_dir = project_substitution_dictionary['@tutorial_01_dir@']
included_files_list = [
    {'target': 'tutorial_01_geometry_SConscript', 'source': f'{project_dir}/{eabm_dir}/{tutorial_01_dir}/SConscript'}
]
for file_dict in included_files_list:
    Command(target=file_dict['target'],
            source=file_dict['source'],
            action=Copy("$TARGET", "$SOURCE"))

# Explicit Sphinx documentation dependency list
documentation_file_list = [
    'conf.py',  # Generated by an SCons target
    'abaqus_wrapper_message.txt',  # Generated by an SCons target
    'README.txt',  # Copied from README.rst to docs build directory by root SConscript
    'environment.txt',  # Copied from environment.txt to docs build directory by root SConscript
    'api.rst',
    'build.txt',
    'changelog.rst',
    'cli.rst',
    'contribution.txt',
    'dependencies.txt',
    'devops.rst',
    'documentation.txt',
    'index.rst',
    'project_brief.txt',
    'references.bib',
    'release_philosophy.rst',
    'targets.txt',
    'theory.rst',
    'tutorial_01_geometry_waves.rst',
    'user.rst',
    'zreferences.rst',
    '_static/custom.css'
]
for file_dict in included_files_list:
    documentation_file_list.append(file_dict['target'])

# Copy tutorial files to the build/docs directory
project_dir = pathlib.Path(env['project_dir'])
eabm_dir = project_dir / pathlib.Path(env['eabm_dir'])
abaqus_dir = pathlib.Path(env['abaqus_dir'])
tutorial_files_list = [ # tutorial_01_dir / 'SConscript',
                        # abaqus_dir / 'single_element_geometry.py',
]
for filepath in tutorial_files_list:
    target = f'{filepath.parents[0]}_{filepath.name}'
    Command(target=target,
            source=str(eabm_dir / filepath),
            action=Copy("$TARGET", "$SOURCE"))
    documentation_file_list.append(target)

# TODO: os agnostic pathsep for the html directory
# https://re-git.lanl.gov/kbrindley/waves/-/issues/4
sphinx_options = '-W'
documentation = env.Command(
    # TODO: figure out how to keep the Command in the "build/docs" directory without a leading dummy filename
    # https://re-git.lanl.gov/kbrindley/waves/-/issues/5
    target=['dummy_file', 'html/index.html'],
    source=documentation_file_list,
    action=f"{env['sphinx_build']} ${{sphinx_options}} -b html ${{TARGET.dir.abspath}} ${{TARGET.dir.abspath}}/html",
    sphinx_options=sphinx_options)
env.Clean(documentation, 'html/')
alias_list = env.Alias('documentation', documentation)

if env['conditional_ignore'] and not env['sphinx_build']:
    print(f"Program 'sphinx-build' was not found in construction environment. Ignoring Sphinx target(s)")
    Ignore(['.', 'html', 'documentation'], documentation)


# Return the alias list to SConstruct for help message output
Return('alias_list')
